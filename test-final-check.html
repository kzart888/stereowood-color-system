<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Final System Check</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .info { color: blue; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>üîç Final System Check</h1>
    
    <div class="test-section">
        <h2>1. Component Loading Test</h2>
        <button onclick="testComponents()">Test Components</button>
        <div id="component-results"></div>
    </div>
    
    <div class="test-section">
        <h2>2. API Connectivity Test</h2>
        <button onclick="testAPI()">Test API</button>
        <div id="api-results"></div>
    </div>
    
    <div class="test-section">
        <h2>3. Color Features Test</h2>
        <button onclick="testColorFeatures()">Test Color Features</button>
        <div id="color-results"></div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.4.0/axios.min.js"></script>
    
    <script>
        async function testComponents() {
            const resultDiv = document.getElementById('component-results');
            let html = '<h3>Testing Component Loading...</h3>';
            
            try {
                // Load the main page
                const response = await axios.get('http://localhost:9099/');
                const pageHtml = response.data;
                
                // Check if key scripts are included
                const scripts = [
                    'custom-colors.js',
                    'artworks.js',
                    'mont-marte.js',
                    'color-converter.js',
                    'pantone-colors.js'
                ];
                
                scripts.forEach(script => {
                    if (pageHtml.includes(script)) {
                        html += `<div class="success">‚úÖ ${script} is loaded</div>`;
                    } else {
                        html += `<div class="error">‚ùå ${script} is missing</div>`;
                    }
                });
                
            } catch (error) {
                html += `<div class="error">‚ùå Failed to load page: ${error.message}</div>`;
            }
            
            resultDiv.innerHTML = html;
        }
        
        async function testAPI() {
            const resultDiv = document.getElementById('api-results');
            let html = '<h3>Testing API Endpoints...</h3>';
            
            const endpoints = [
                '/api/custom-colors',
                '/api/categories',
                '/api/artworks',
                '/api/mont-marte-colors'
            ];
            
            for (const endpoint of endpoints) {
                try {
                    const response = await axios.get(`http://localhost:9099${endpoint}`);
                    const dataLength = Array.isArray(response.data) ? response.data.length : 1;
                    html += `<div class="success">‚úÖ ${endpoint}: ${dataLength} records</div>`;
                } catch (error) {
                    html += `<div class="error">‚ùå ${endpoint}: ${error.message}</div>`;
                }
            }
            
            resultDiv.innerHTML = html;
        }
        
        async function testColorFeatures() {
            const resultDiv = document.getElementById('color-results');
            let html = '<h3>Testing Color Enhancement Features...</h3>';
            
            try {
                // Test creating a color with all new fields
                const testColor = {
                    category_id: 1,
                    color_code: 'FINAL-TEST-' + Date.now(),
                    formula: 'ÊµãËØïÈÖçÊñπ 10g',
                    rgb_r: 200,
                    rgb_g: 100,
                    rgb_b: 50,
                    hex_color: '#C86432',
                    cmyk_c: 0,
                    cmyk_m: 50,
                    cmyk_y: 75,
                    cmyk_k: 22,
                    pantone_coated: 'Test C',
                    pantone_uncoated: 'Test U'
                };
                
                // Create
                const createResp = await axios.post('http://localhost:9099/api/custom-colors', testColor);
                if (createResp.data.id) {
                    html += '<div class="success">‚úÖ Color creation with new fields: PASSED</div>';
                    
                    // Verify fields were saved
                    const getResp = await axios.get(`http://localhost:9099/api/custom-colors/${createResp.data.id}`);
                    const saved = getResp.data;
                    
                    const fieldsToCheck = ['rgb_r', 'rgb_g', 'rgb_b', 'hex_color', 'cmyk_c', 'pantone_coated'];
                    let allFieldsSaved = true;
                    
                    fieldsToCheck.forEach(field => {
                        if (saved[field] !== undefined && saved[field] !== null) {
                            html += `<div class="info">  ‚úì ${field}: ${saved[field]}</div>`;
                        } else {
                            html += `<div class="error">  ‚úó ${field}: missing</div>`;
                            allFieldsSaved = false;
                        }
                    });
                    
                    if (allFieldsSaved) {
                        html += '<div class="success">‚úÖ All color fields saved correctly</div>';
                    }
                    
                    // Clean up
                    await axios.delete(`http://localhost:9099/api/custom-colors/${createResp.data.id}`);
                    html += '<div class="info">üßπ Test data cleaned up</div>';
                } else {
                    html += '<div class="error">‚ùå Failed to create test color</div>';
                }
                
            } catch (error) {
                html += `<div class="error">‚ùå Color feature test failed: ${error.message}</div>`;
            }
            
            resultDiv.innerHTML = html;
        }
        
        // Auto-run tests on load
        window.onload = async function() {
            console.log('Running final system checks...');
            await testComponents();
            await testAPI();
            await testColorFeatures();
        };
    </script>
</body>
</html>