<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Color Features Integration Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            max-width: 1200px; 
            margin: 0 auto;
        }
        .test-section { 
            margin: 20px 0; 
            padding: 20px; 
            border: 1px solid #ddd; 
            border-radius: 8px;
        }
        .test-result { 
            margin: 10px 0; 
            padding: 10px; 
            background: #f0f0f0; 
            border-radius: 4px;
        }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .warning { color: orange; font-weight: bold; }
        button { 
            margin: 5px; 
            padding: 8px 16px; 
            background: #409EFF;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover { background: #66b1ff; }
        .color-box { 
            width: 50px; 
            height: 50px; 
            display: inline-block; 
            margin: 5px; 
            border: 2px solid #333;
            border-radius: 4px;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .performance-metric {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
    </style>
</head>
<body>
    <h1>üß™ Color Features Integration Test Suite</h1>
    <p>Complete testing for RGB/CMYK/HEX/Pantone color enhancement features</p>
    
    <!-- Test Controls -->
    <div class="test-section">
        <h2>Test Controls</h2>
        <button onclick="runAllTests()">üöÄ Run All Tests</button>
        <button onclick="clearResults()">üóëÔ∏è Clear Results</button>
        <button onclick="runPerformanceTests()">‚ö° Performance Tests</button>
    </div>

    <!-- API Testing -->
    <div class="test-section">
        <h2>1. Backend API Tests</h2>
        <button onclick="testCreateColorWithAllFields()">Test Create Color</button>
        <button onclick="testUpdateColorFields()">Test Update Color</button>
        <button onclick="testValidation()">Test Validation</button>
        <div id="api-results" class="test-result"></div>
    </div>

    <!-- Color Conversion Tests -->
    <div class="test-section">
        <h2>2. Color Conversion Tests</h2>
        <div class="test-grid">
            <div>
                <h3>RGB ‚Üí Other Formats</h3>
                R: <input type="number" id="test-r" value="255" min="0" max="255">
                G: <input type="number" id="test-g" value="100" min="0" max="255">
                B: <input type="number" id="test-b" value="50" min="0" max="255">
                <button onclick="testRGBConversions()">Convert</button>
                <div id="rgb-conversion-result"></div>
            </div>
            <div>
                <h3>HEX ‚Üí Other Formats</h3>
                HEX: <input type="text" id="test-hex" value="#FF6432">
                <button onclick="testHEXConversions()">Convert</button>
                <div id="hex-conversion-result"></div>
            </div>
        </div>
    </div>

    <!-- Image Extraction Test -->
    <div class="test-section">
        <h2>3. Image Color Extraction Test</h2>
        <input type="file" id="test-image" accept="image/*">
        <button onclick="testImageExtraction()">Extract Colors</button>
        <div id="extraction-result" class="test-result"></div>
        <canvas id="test-canvas" style="display:none;"></canvas>
    </div>

    <!-- Pantone Matching Test -->
    <div class="test-section">
        <h2>4. Pantone Matching Test</h2>
        <button onclick="testPantoneMatching()">Test Various Colors</button>
        <div id="pantone-result" class="test-result"></div>
    </div>

    <!-- Performance Tests -->
    <div class="test-section">
        <h2>5. Performance Benchmarks</h2>
        <div id="performance-result" class="test-result"></div>
    </div>

    <!-- Load dependencies -->
    <script src="frontend/js/utils/color-converter.js"></script>
    <script src="frontend/js/data/pantone-colors.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.4.0/axios.min.js"></script>
    
    <script>
        const API_BASE = 'http://localhost:9099/api';
        
        // Clear results
        function clearResults() {
            document.querySelectorAll('.test-result').forEach(el => el.innerHTML = '');
        }
        
        // 1. API Tests
        async function testCreateColorWithAllFields() {
            const resultDiv = document.getElementById('api-results');
            try {
                const testData = {
                    category_id: 1,
                    color_code: 'TEST-' + Date.now(),
                    formula: 'ÈíõÁôΩ 50g Â§©Ëìù 30g',
                    rgb_r: 100,
                    rgb_g: 150,
                    rgb_b: 200,
                    cmyk_c: 50,
                    cmyk_m: 25,
                    cmyk_y: 0,
                    cmyk_k: 22,
                    hex_color: '#6496C8',
                    pantone_coated: '2718 C',
                    pantone_uncoated: '2718 U'
                };
                
                const response = await axios.post(`${API_BASE}/custom-colors`, testData);
                
                if (response.data.id) {
                    resultDiv.innerHTML = `
                        <div class="success">‚úÖ Create Test Passed</div>
                        <pre>${JSON.stringify(response.data, null, 2)}</pre>
                        <div>Created color ID: ${response.data.id}</div>
                    `;
                    
                    // Clean up - delete test color
                    await axios.delete(`${API_BASE}/custom-colors/${response.data.id}`);
                    resultDiv.innerHTML += '<div class="success">‚úÖ Test color cleaned up</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Create Test Failed: ${error.message}</div>`;
            }
        }
        
        async function testUpdateColorFields() {
            const resultDiv = document.getElementById('api-results');
            try {
                // First create a test color
                const createData = {
                    category_id: 1,
                    color_code: 'UPDATE-TEST-' + Date.now(),
                    formula: 'ÊµãËØïÈÖçÊñπ 10g'
                };
                
                const createResp = await axios.post(`${API_BASE}/custom-colors`, createData);
                const colorId = createResp.data.id;
                
                // Update with color fields
                const updateData = {
                    rgb_r: 255,
                    rgb_g: 0,
                    rgb_b: 0,
                    hex_color: '#FF0000',
                    pantone_coated: '185 C'
                };
                
                const updateResp = await axios.put(`${API_BASE}/custom-colors/${colorId}`, updateData);
                
                // Verify update
                const getResp = await axios.get(`${API_BASE}/custom-colors/${colorId}`);
                const updated = getResp.data;
                
                if (updated.rgb_r === 255 && updated.hex_color === '#FF0000') {
                    resultDiv.innerHTML = `
                        <div class="success">‚úÖ Update Test Passed</div>
                        <pre>${JSON.stringify(updated, null, 2)}</pre>
                    `;
                    
                    // Clean up
                    await axios.delete(`${API_BASE}/custom-colors/${colorId}`);
                    resultDiv.innerHTML += '<div class="success">‚úÖ Test color cleaned up</div>';
                } else {
                    throw new Error('Update verification failed');
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Update Test Failed: ${error.message}</div>`;
            }
        }
        
        async function testValidation() {
            const resultDiv = document.getElementById('api-results');
            let results = [];
            
            // Test invalid RGB
            try {
                await axios.post(`${API_BASE}/custom-colors`, {
                    category_id: 1,
                    color_code: 'INVALID-RGB',
                    formula: 'test',
                    rgb_r: 300 // Invalid
                });
                results.push('<div class="error">‚ùå RGB validation failed - accepted invalid value</div>');
            } catch (error) {
                if (error.response?.data?.error?.includes('RGB')) {
                    results.push('<div class="success">‚úÖ RGB validation working</div>');
                }
            }
            
            // Test invalid CMYK
            try {
                await axios.post(`${API_BASE}/custom-colors`, {
                    category_id: 1,
                    color_code: 'INVALID-CMYK',
                    formula: 'test',
                    cmyk_c: 150 // Invalid
                });
                results.push('<div class="error">‚ùå CMYK validation failed - accepted invalid value</div>');
            } catch (error) {
                if (error.response?.data?.error?.includes('CMYK')) {
                    results.push('<div class="success">‚úÖ CMYK validation working</div>');
                }
            }
            
            // Test invalid HEX
            try {
                await axios.post(`${API_BASE}/custom-colors`, {
                    category_id: 1,
                    color_code: 'INVALID-HEX',
                    formula: 'test',
                    hex_color: 'INVALID'
                });
                results.push('<div class="error">‚ùå HEX validation failed - accepted invalid value</div>');
            } catch (error) {
                if (error.response?.data?.error?.includes('HEX')) {
                    results.push('<div class="success">‚úÖ HEX validation working</div>');
                }
            }
            
            resultDiv.innerHTML = results.join('');
        }
        
        // 2. Color Conversion Tests
        function testRGBConversions() {
            const r = parseInt(document.getElementById('test-r').value);
            const g = parseInt(document.getElementById('test-g').value);
            const b = parseInt(document.getElementById('test-b').value);
            const resultDiv = document.getElementById('rgb-conversion-result');
            
            try {
                const hex = ColorConverter.rgbToHex(r, g, b);
                const cmyk = ColorConverter.rgbToCmyk(r, g, b);
                const pantone = ColorConverter.findClosestPantone({r, g, b}, PANTONE_COLORS);
                
                resultDiv.innerHTML = `
                    <div class="success">‚úÖ Conversion Success</div>
                    <div>HEX: ${hex} <div class="color-box" style="background: ${hex}"></div></div>
                    <div>CMYK: C:${cmyk.c} M:${cmyk.m} Y:${cmyk.y} K:${cmyk.k}</div>
                    <div>Closest Pantone: ${pantone ? pantone.code : 'Not found'}</div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Conversion failed: ${error.message}</div>`;
            }
        }
        
        function testHEXConversions() {
            const hex = document.getElementById('test-hex').value;
            const resultDiv = document.getElementById('hex-conversion-result');
            
            try {
                const rgb = ColorConverter.hexToRgb(hex);
                const cmyk = ColorConverter.rgbToCmyk(rgb.r, rgb.g, rgb.b);
                
                resultDiv.innerHTML = `
                    <div class="success">‚úÖ Conversion Success</div>
                    <div>RGB: R:${rgb.r} G:${rgb.g} B:${rgb.b}</div>
                    <div>CMYK: C:${cmyk.c} M:${cmyk.m} Y:${cmyk.y} K:${cmyk.k}</div>
                    <div class="color-box" style="background: ${hex}"></div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Conversion failed: ${error.message}</div>`;
            }
        }
        
        // 3. Image Extraction Test
        async function testImageExtraction() {
            const fileInput = document.getElementById('test-image');
            const resultDiv = document.getElementById('extraction-result');
            
            if (!fileInput.files[0]) {
                resultDiv.innerHTML = '<div class="warning">‚ö†Ô∏è Please select an image first</div>';
                return;
            }
            
            try {
                const startTime = performance.now();
                const color = await ColorConverter.extractColorFromImage(fileInput.files[0]);
                const endTime = performance.now();
                
                resultDiv.innerHTML = `
                    <div class="success">‚úÖ Extraction Success (${(endTime - startTime).toFixed(2)}ms)</div>
                    <div>RGB: ${color.r}, ${color.g}, ${color.b}</div>
                    <div>HEX: ${color.hex}</div>
                    <div>CMYK: C:${color.cmyk.c} M:${color.cmyk.m} Y:${color.cmyk.y} K:${color.cmyk.k}</div>
                    <div class="color-box" style="background: ${color.hex}"></div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Extraction failed: ${error.message}</div>`;
            }
        }
        
        // 4. Pantone Matching Test
        function testPantoneMatching() {
            const resultDiv = document.getElementById('pantone-result');
            const testColors = [
                { name: 'Pure Red', rgb: {r: 255, g: 0, b: 0} },
                { name: 'Pure Blue', rgb: {r: 0, g: 0, b: 255} },
                { name: 'Pure Green', rgb: {r: 0, g: 255, b: 0} },
                { name: 'Orange', rgb: {r: 255, g: 165, b: 0} },
                { name: 'Purple', rgb: {r: 128, g: 0, b: 128} }
            ];
            
            let html = '<h3>Pantone Matching Results:</h3>';
            
            testColors.forEach(color => {
                const startTime = performance.now();
                const match = ColorConverter.findClosestPantone(color.rgb, PANTONE_COLORS);
                const endTime = performance.now();
                
                html += `
                    <div style="margin: 10px 0;">
                        <strong>${color.name}</strong> 
                        <div class="color-box" style="background: rgb(${color.rgb.r},${color.rgb.g},${color.rgb.b})"></div>
                        ‚Üí ${match ? match.code : 'No match'} 
                        <div class="color-box" style="background: ${match ? match.hex : '#fff'}"></div>
                        (${(endTime - startTime).toFixed(2)}ms)
                    </div>
                `;
            });
            
            resultDiv.innerHTML = html;
        }
        
        // 5. Performance Tests
        async function runPerformanceTests() {
            const resultDiv = document.getElementById('performance-result');
            let results = [];
            
            // Test 1: RGB to HEX conversion speed
            const rgbStart = performance.now();
            for (let i = 0; i < 1000; i++) {
                ColorConverter.rgbToHex(255, 100, 50);
            }
            const rgbEnd = performance.now();
            results.push({
                name: 'RGB‚ÜíHEX (1000x)',
                time: (rgbEnd - rgbStart).toFixed(2),
                status: (rgbEnd - rgbStart) < 10 ? 'success' : 'warning'
            });
            
            // Test 2: Pantone matching speed
            const pantoneStart = performance.now();
            for (let i = 0; i < 100; i++) {
                ColorConverter.findClosestPantone({r: 255, g: 100, b: 50}, PANTONE_COLORS);
            }
            const pantoneEnd = performance.now();
            results.push({
                name: 'Pantone Match (100x)',
                time: (pantoneEnd - pantoneStart).toFixed(2),
                status: (pantoneEnd - pantoneStart) < 500 ? 'success' : 'warning'
            });
            
            // Test 3: CMYK conversion speed
            const cmykStart = performance.now();
            for (let i = 0; i < 1000; i++) {
                ColorConverter.rgbToCmyk(255, 100, 50);
            }
            const cmykEnd = performance.now();
            results.push({
                name: 'RGB‚ÜíCMYK (1000x)',
                time: (cmykEnd - cmykStart).toFixed(2),
                status: (cmykEnd - cmykStart) < 10 ? 'success' : 'warning'
            });
            
            // Display results
            let html = '<h3>Performance Metrics:</h3>';
            results.forEach(result => {
                const icon = result.status === 'success' ? '‚úÖ' : '‚ö†Ô∏è';
                html += `
                    <div class="performance-metric">
                        <span>${result.name}</span>
                        <span class="${result.status}">${icon} ${result.time}ms</span>
                    </div>
                `;
            });
            
            resultDiv.innerHTML = html;
        }
        
        // Run all tests
        async function runAllTests() {
            console.log('Starting comprehensive test suite...');
            
            // Clear previous results
            clearResults();
            
            // Run tests in sequence
            await testCreateColorWithAllFields();
            await new Promise(r => setTimeout(r, 500));
            
            await testUpdateColorFields();
            await new Promise(r => setTimeout(r, 500));
            
            await testValidation();
            await new Promise(r => setTimeout(r, 500));
            
            testRGBConversions();
            testHEXConversions();
            testPantoneMatching();
            
            await runPerformanceTests();
            
            console.log('All tests completed!');
        }
        
        // Auto-run performance test on load
        window.onload = function() {
            console.log('Test suite loaded');
            console.log('ColorConverter:', typeof ColorConverter !== 'undefined' ? 'Loaded' : 'Not found');
            console.log('Pantone colors:', typeof PANTONE_COLORS !== 'undefined' ? PANTONE_COLORS.length + ' colors' : 'Not found');
        };
    </script>
</body>
</html>