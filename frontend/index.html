<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>叠雕画颜色管理系统</title>
    
    <!-- 引入Vue 3和Element Plus -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/element-plus/2.3.14/index.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/element-plus/2.3.14/index.full.min.js"></script>
    
    <!-- 引入axios进行HTTP请求 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.4.0/axios.min.js"></script>
    
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .system-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            color: white;
        }
        
        .color-bar {
            background: white;
            margin-bottom: 15px;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .color-sample {
            width: 80px;
            height: 60px;
            border-radius: 6px;
            border: 2px solid #ddd;
            background-size: cover;
            background-position: center;
            flex-shrink: 0;
        }
        
        .color-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .color-code {
            font-weight: bold;
            font-size: 16px;
            color: #409EFF;
        }
        
        .color-formula {
            color: #666;
            font-size: 14px;
        }
        
        .color-layers {
            color: #888;
            font-size: 12px;
        }
        
        .color-actions {
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }
        
        .artwork-bar {
            background: white;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .artwork-header {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .artwork-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        
        .scheme-bar {
            padding: 20px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .scheme-bar:last-child {
            border-bottom: none;
        }
        
        .scheme-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .scheme-thumbnail {
            width: 100px;
            height: 80px;
            border-radius: 6px;
            border: 2px solid #ddd;
            background-size: cover;
            background-position: center;
            flex-shrink: 0;
        }
        
        .scheme-name {
            font-size: 16px;
            font-weight: bold;
            color: #409EFF;
        }
        
        .layer-table {
            width: 100%;
            margin-top: 15px;
            border-collapse: collapse;
        }
        
        .layer-table th,
        .layer-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            font-size: 12px;
        }
        
        .layer-table th {
            background: #f5f5f5;
            font-weight: bold;
        }
        
        .mont-marte-bar {
            background: white;
            margin-bottom: 15px;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }
        
        .tab-content {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .category-tabs {
            margin-bottom: 20px;
        }
        
        .view-toggle {
            float: right;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="main-container">
            <!-- 系统标题 -->
            <div class="system-header">
                <h1>叠雕画颜色管理系统</h1>
                <p>为工厂师傅提供便捷的颜色查阅和配色管理</p>
            </div>
            
            <!-- 主要导航标签页 -->
            <el-tabs v-model="activeTab" type="card">
                
                <!-- 第一个页面：全部自配颜色列表 -->
                <el-tab-pane label="自配颜色管理" name="custom-colors">
                    <div class="tab-content">
                        <!-- 颜色分类标签页 -->
                        <el-tabs 
                            v-model="activeCategory" 
                            class="category-tabs"
                            @tab-add="addCategory"
                            @tab-remove="removeCategory"
                            type="card" 
                            editable
                        >
                            <el-tab-pane 
                                v-for="category in categories" 
                                :key="category.id"
                                :label="category.name" 
                                :name="category.id.toString()"
                                :closable="false"
                            >
                                <!-- 添加新颜色按钮 -->
                                <el-button 
                                    type="primary" 
                                    icon="Plus" 
                                    @click="showAddColorDialog = true"
                                    style="margin-bottom: 20px;"
                                >
                                    添加新的自配色
                                </el-button>
                                
                                <!-- 自配颜色列表 -->
                                <div v-if="loading" class="loading">
                                    <el-icon class="is-loading"><Loading /></el-icon>
                                    加载中...
                                </div>
                                
                                <div v-else>
                                    <!-- 单个颜色条目 -->
                                    <div 
                                        v-for="color in getCurrentCategoryColors()" 
                                        :key="color.id" 
                                        class="color-bar"
                                    >
                                        <!-- 颜色样本 -->
                                        <div 
                                            class="color-sample"
                                            :style="{ backgroundImage: color.image_path ? `url(${baseURL}/${color.image_path})` : '' }"
                                        ></div>
                                        
                                        <!-- 颜色信息 -->
                                        <div class="color-info">
                                            <div class="color-code">{{ color.color_code }}</div>
                                            <div class="color-formula">配方: {{ color.formula || '未设置' }}</div>
                                            <div class="color-layers">适用层: {{ color.applicable_layers || '未设置' }}</div>
                                            <div style="font-size: 12px; color: #999;">
                                                最后修改: {{ formatDate(color.updated_at) }}
                                            </div>
                                        </div>
                                        
                                        <!-- 操作按钮 -->
                                        <div class="color-actions">
                                            <el-button size="small" @click="editColor(color)">修改</el-button>
                                            <el-button 
                                                size="small" 
                                                type="info" 
                                                @click="viewColorHistory(color)"
                                            >
                                                回溯
                                            </el-button>
                                        </div>
                                    </div>
                                    
                                    <!-- 无数据提示 -->
                                    <div v-if="getCurrentCategoryColors().length === 0" class="loading">
                                        暂无自配颜色数据
                                    </div>
                                </div>
                            </el-tab-pane>
                        </el-tabs>
                    </div>
                </el-tab-pane>
                
                <!-- 第二个页面：画的种类和配色方案 -->
                <el-tab-pane label="作品配色管理" name="artworks">
                    <div class="tab-content">
                        <!-- 视图切换按钮 -->
                        <div class="view-toggle">
                            <el-button 
                                @click="toggleLayerView" 
                                :type="layerViewMode === 'layer-first' ? 'primary' : 'default'"
                                size="small"
                            >
                                {{ layerViewMode === 'layer-first' ? '层号优先视图' : '颜色优先视图' }}
                            </el-button>
                        </div>
                        
                        <!-- 添加新作品按钮 -->
                        <el-button 
                            type="primary" 
                            icon="Plus" 
                            @click="showAddArtworkDialog = true"
                            style="margin-bottom: 20px;"
                        >
                            添加新作品
                        </el-button>
                        
                        <!-- 作品列表 -->
                        <div v-if="loading" class="loading">
                            <el-icon class="is-loading"><Loading /></el-icon>
                            加载中...
                        </div>
                        
                        <div v-else>
                            <!-- 单个作品 (母bar) -->
                            <div v-for="artwork in artworks" :key="artwork.id" class="artwork-bar">
                                <!-- 作品头部 -->
                                <div class="artwork-header">
                                    <div class="artwork-title">{{ artwork.code }} - {{ artwork.name }}</div>
                                    <el-button size="small" @click="addScheme(artwork)">+ 配色方案</el-button>
                                </div>
                                
                                <!-- 配色方案列表 (子bar) -->
                                <div v-for="scheme in artwork.schemes" :key="scheme.id" class="scheme-bar">
                                    <div class="scheme-header">
                                        <!-- 缩略图 -->
                                        <div 
                                            class="scheme-thumbnail"
                                            :style="{ backgroundImage: scheme.thumbnail_path ? `url(${baseURL}/${scheme.thumbnail_path})` : '' }"
                                        ></div>
                                        
                                        <!-- 配色方案信息 -->
                                        <div style="flex: 1;">
                                            <div class="scheme-name">{{ scheme.scheme_name }}</div>
                                            <div style="font-size: 12px; color: #999;">
                                                最后修改: {{ formatDate(scheme.updated_at) }}
                                            </div>
                                        </div>
                                        
                                        <!-- 操作按钮 -->
                                        <div class="color-actions">
                                            <el-button size="small" @click="editScheme(scheme)">修改</el-button>
                                            <el-button 
                                                size="small" 
                                                type="info" 
                                                @click="viewSchemeHistory(scheme)"
                                            >
                                                回溯
                                            </el-button>
                                        </div>
                                    </div>
                                    
                                    <!-- 层号-颜色对应表格 -->
                                    <div v-if="layerViewMode === 'layer-first'">
                                        <!-- 层号优先视图：第一行层号，第二行颜色编号，第三行配方 -->
                                        <table class="layer-table">
                                            <tr>
                                                <th>层号</th>
                                                <th v-for="layer in scheme.layerData" :key="'layer-' + layer.layer">
                                                    {{ layer.layer }}
                                                </th>
                                            </tr>
                                            <tr>
                                                <th>色号</th>
                                                <td v-for="layer in scheme.layerData" :key="'color-' + layer.layer">
                                                    {{ layer.colorCode }}
                                                </td>
                                            </tr>
                                            <tr>
                                                <th>配方</th>
                                                <td v-for="layer in scheme.layerData" :key="'formula-' + layer.layer">
                                                    {{ layer.formula }}
                                                </td>
                                            </tr>
                                        </table>
                                    </div>
                                    
                                    <div v-else>
                                        <!-- 颜色优先视图：第一行颜色编号，第二行配方，第三行层号 -->
                                        <table class="layer-table">
                                            <tr>
                                                <th>色号</th>
                                                <th v-for="color in scheme.colorData" :key="'color-' + color.colorCode">
                                                    {{ color.colorCode }}
                                                </th>
                                            </tr>
                                            <tr>
                                                <th>配方</th>
                                                <td v-for="color in scheme.colorData" :key="'formula-' + color.colorCode">
                                                    {{ color.formula }}
                                                </td>
                                            </tr>
                                            <tr>
                                                <th>层号</th>
                                                <td v-for="color in scheme.colorData" :key="'layers-' + color.colorCode">
                                                    {{ color.layers.join(', ') }}
                                                </td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 无数据提示 -->
                            <div v-if="artworks.length === 0" class="loading">
                                暂无作品数据
                            </div>
                        </div>
                    </div>
                </el-tab-pane>
                
                <!-- 第三个页面：蒙马特颜色列表 -->
                <el-tab-pane label="颜色原料库" name="mont-marte">
                    <div class="tab-content">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <!-- 添加新颜色按钮 -->
                            <el-button 
                                type="primary" 
                                icon="Plus" 
                                @click="showAddMontMarteDialog = true"
                            >
                                添加颜色原料
                            </el-button>
                            
                            <!-- 排序按钮组 -->
                            <el-button-group>
                                <el-button 
                                    :type="montMarteSortType === 'name' ? 'primary' : 'default'"
                                    @click="sortByNameClick"
                                    icon="Sort"
                                >
                                    按名称排序
                                </el-button>
                                <el-button 
                                    :type="montMarteSortType === 'time' ? 'primary' : 'default'"
                                    @click="sortByTimeClick"
                                    icon="Clock"
                                >
                                    按时间排序
                                </el-button>
                            </el-button-group>
                        </div>
                        
                        <!-- 蒙马特颜色列表 -->
                        <div v-if="loading" class="loading">
                            <el-icon class="is-loading"><Loading /></el-icon>
                            加载中...
                        </div>
                        
                        <div v-else>
                            <!-- 单个蒙马特颜色条目 -->
                            <div 
                                v-for="color in montMarteColors" 
                                :key="color.id" 
                                class="mont-marte-bar"
                            >
                                <!-- 颜色样本 -->
                                <div 
                                    class="color-sample"
                                    :style="{ backgroundImage: color.image_path ? `url(${baseURL}/${color.image_path})` : '' }"
                                ></div>
                                
                                <!-- 颜色名称 -->
                                <div class="color-info">
                                    <div class="color-code">{{ color.name }}</div>
                                    <div style="font-size: 12px; color: #999;">
                                        添加时间: {{ formatDate(color.created_at) }}
                                    </div>
                                </div>
                                
                                <!-- 操作按钮 -->
                                <div class="color-actions">
                                    <el-button size="small" @click="editMontMarteColor(color)">修改</el-button>
                                    <el-button 
                                        size="small" 
                                        type="danger" 
                                        @click="deleteMontMarteColor(color)"
                                    >
                                        删除
                                    </el-button>
                                </div>
                            </div>
                            
                            <!-- 无数据提示 -->
                            <div v-if="montMarteColors.length === 0" class="loading">
                                暂无蒙马特颜色数据
                            </div>
                        </div>
                    </div>
                </el-tab-pane>
            </el-tabs>
            
            <!-- 添加自配颜色对话框 -->
            <el-dialog 
                v-model="showAddColorDialog" 
                title="添加自配颜色" 
                width="600px"
                @close="resetColorForm"
                @open="initColorForm"
            >
                <el-form 
                    :model="colorForm" 
                    :rules="colorRules"
                    ref="colorFormRef"
                    label-width="100px"
                >
                    <el-form-item label="颜色分类" prop="category_id">
                        <el-select 
                            v-model="colorForm.category_id" 
                            placeholder="请选择颜色分类"
                            @change="onCategoryChange"
                        >
                            <el-option 
                                v-for="category in categories" 
                                :key="category.id"
                                :label="category.name" 
                                :value="category.id"
                            ></el-option>
                        </el-select>
                    </el-form-item>
                    <el-form-item label="颜色编号" prop="color_code">
                        <el-input 
                            v-model="colorForm.color_code" 
                            placeholder="例如: BU001, YE005"
                        ></el-input>
                    </el-form-item>
                    <el-form-item label="配方" prop="formula">
                        <el-input 
                            v-model="colorForm.formula" 
                            type="textarea"
                            rows="3"
                            placeholder="例如: 蓝5g 紫红10g 灰2g"
                        ></el-input>
                    </el-form-item>
                    <el-form-item label="适用画层">
                        <el-input 
                            v-model="colorForm.applicable_layers" 
                            placeholder="例如: 078-蝶恋花(4)(8)(12)"
                        ></el-input>
                    </el-form-item>
                    <el-form-item label="颜色样本">
                        <el-upload
                            :auto-upload="false"
                            :show-file-list="false"
                            :on-change="handleColorImageChange"
                            accept="image/*"
                        >
                            <el-button>选择图片</el-button>
                            <div v-if="colorForm.imagePreview" style="margin-top: 10px;">
                                <img :src="colorForm.imagePreview" style="width: 100px; height: 80px; object-fit: cover; border-radius: 4px;">
                            </div>
                        </el-upload>
                    </el-form-item>
                </el-form>
                <template #footer>
                    <el-button @click="showAddColorDialog = false">取消</el-button>
                    <el-button type="primary" @click="saveColor">保存</el-button>
                </template>
            </el-dialog>
            
            <!-- 添加作品对话框 -->
            <el-dialog 
                v-model="showAddArtworkDialog" 
                title="添加新作品" 
                width="500px"
                @close="resetArtworkForm"
            >
                <el-form :model="artworkForm" label-width="100px">
                    <el-form-item label="作品编号">
                        <el-input v-model="artworkForm.code" placeholder="例如: 078-太极鱼"></el-input>
                    </el-form-item>
                    <el-form-item label="作品名称">
                        <el-input v-model="artworkForm.name" placeholder="例如: 太极鱼"></el-input>
                    </el-form-item>
                </el-form>
                <template #footer>
                    <el-button @click="showAddArtworkDialog = false">取消</el-button>
                    <el-button type="primary" @click="saveArtwork">保存</el-button>
                </template>
            </el-dialog>
            
            <!-- 添加/修改蒙马特颜色对话框 -->
            <el-dialog 
                v-model="showAddMontMarteDialog" 
                :title="montMarteForm.id ? '修改颜色原料' : '添加颜色原料'" 
                width="500px"
                @close="resetMontMarteForm"
            >
                <el-form 
                    :model="montMarteForm" 
                    :rules="montMarteRules" 
                    ref="montMarteFormRef" 
                    label-width="100px"
                    @submit.prevent="saveMontMarteColor"
                >
                    <el-form-item label="颜色名称" prop="name">
                        <el-input 
                            v-model="montMarteForm.name" 
                            placeholder="例如: 朱红, 桔黄"
                            @keyup.enter="saveMontMarteColor"
                        ></el-input>
                    </el-form-item>
                    <el-form-item label="颜色照片">
                        <el-upload
                            :auto-upload="false"
                            :show-file-list="false"
                            :on-change="handleMontMarteImageChange"
                            accept="image/*"
                        >
                            <el-button>{{ montMarteForm.imagePreview ? '更换图片' : '选择图片' }}</el-button>
                            <div v-if="montMarteForm.imagePreview" style="margin-top: 10px;">
                                <img :src="montMarteForm.imagePreview" style="width: 100px; height: 80px; object-fit: cover; border-radius: 4px;">
                            </div>
                        </el-upload>
                    </el-form-item>
                </el-form>
                <template #footer>
                    <el-button @click="showAddMontMarteDialog = false">取消</el-button>
                    <el-button type="primary" @click="saveMontMarteColor">保存</el-button>
                </template>
            </el-dialog>
        </div>
    </div>

    <script>
        const { createApp } = Vue;
        const ElementPlus = window.ElementPlus;

        // 配置后端API基础URL
        const API_BASE_URL = 'http://localhost:3000/api';
        
        createApp({
            data() {
                return {
                    // 基础配置
                    baseURL: 'http://localhost:3000',
                    loading: false,
                    
                    // 主导航
                    activeTab: 'custom-colors',
                    
                    // 颜色分类管理
                    activeCategory: '1',
                    categories: [],
                    
                    // 自配颜色相关
                    customColors: [],
                    showAddColorDialog: false,
                    colorForm: {
                        category_id: '',
                        color_code: '',
                        formula: '',
                        applicable_layers: '',
                        imageFile: null,
                        imagePreview: null
                    },
                    // 添加表单验证规则
                    colorRules: {
                        category_id: [
                            { required: true, message: '请选择颜色分类', trigger: 'change' }
                        ],
                        color_code: [
                            { required: true, message: '颜色编号为必填项', trigger: 'blur' },
                            { validator: this.validateColorCode, trigger: 'blur' }
                        ],
                        formula: [
                            { required: true, message: '配方为必填项', trigger: 'blur' }
                        ]
                    },
                    
                    // 作品管理相关
                    artworks: [],
                    layerViewMode: 'layer-first', // 'layer-first' 或 'color-first'
                    showAddArtworkDialog: false,
                    artworkForm: {
                        code: '',
                        name: ''
                    },
                    
                    // 蒙马特颜色相关
                    montMarteColors: [],
                    montMarteSortType: 'name', // 默认按名称排序
                    showAddMontMarteDialog: false,
                    montMarteForm: {
                        id: null,
                        name: '',
                        imageFile: null,
                        imagePreview: null,
                        existingImagePath: null
                    },
                    // 添加表单验证规则
                    montMarteRules: {
                        name: [
                            { required: true, message: '颜色名称为必填项', trigger: 'blur' },
                            { min: 1, max: 50, message: '名称长度应在 1 到 50 个字符之间', trigger: 'blur' },
                            { validator: this.validateColorName, trigger: 'blur' }
                        ]
                    },
                    
                    // 添加滚动位置记录
                    scrollPosition: 0
                };
            },
            
            mounted() {
                this.initApp();
            },
            
            methods: {
                // 初始化应用
                async initApp() {
                    await this.loadCategories();
                    await this.loadCustomColors();
                    await this.loadArtworks();
                    await this.loadMontMarteColors();
                },
                
                // 加载颜色分类
                async loadCategories() {
                    try {
                        const response = await axios.get(`${API_BASE_URL}/categories`);
                        this.categories = response.data;
                        if (this.categories.length > 0 && !this.activeCategory) {
                            this.activeCategory = this.categories[0].id.toString();
                        }
                    } catch (error) {
                        console.error('加载颜色分类失败:', error);
                        this.$message.error('加载颜色分类失败');
                    }
                },
                
                // 加载自配颜色
                async loadCustomColors() {
                    try {
                        this.loading = true;
                        const response = await axios.get(`${API_BASE_URL}/custom-colors`);
                        this.customColors = response.data;
                    } catch (error) {
                        console.error('加载自配颜色失败:', error);
                        this.$message.error('加载自配颜色失败');
                    } finally {
                        this.loading = false;
                    }
                },
                
                // 加载作品列表
                async loadArtworks() {
                    try {
                        this.loading = true;
                        const response = await axios.get(`${API_BASE_URL}/artworks`);
                        this.artworks = response.data.map(artwork => ({
                            ...artwork,
                            schemes: artwork.schemes.map(scheme => ({
                                ...scheme,
                                // 模拟层号-颜色数据（实际应从后端获取）
                                layerData: this.generateMockLayerData(),
                                colorData: this.generateMockColorData()
                            }))
                        }));
                    } catch (error) {
                        console.error('加载作品列表失败:', error);
                        this.$message.error('加载作品列表失败');
                    } finally {
                        this.loading = false;
                    }
                },
                
                // 加载蒙马特颜色
                async loadMontMarteColors(keepPosition = false) {
                    try {
                        if (keepPosition) {
                            this.saveScrollPosition();
                        }
                        
                        this.loading = true;
                        const response = await axios.get(`${API_BASE_URL}/mont-marte-colors`);
                        this.montMarteColors = response.data;
                        
                        // 应用当前的排序方式
                        this.sortMontMarteColors();
                        
                        if (keepPosition) {
                            this.restoreScrollPosition();
                        }
                    } catch (error) {
                        console.error('加载蒙马特颜色失败:', error);
                        this.$message.error('加载蒙马特颜色失败');
                    } finally {
                        this.loading = false;
                    }
                },
                
                // 获取当前分类的颜色
                getCurrentCategoryColors() {
                    const categoryId = parseInt(this.activeCategory);
                    return this.customColors.filter(color => color.category_id === categoryId);
                },
                
                // 切换层号视图模式
                toggleLayerView() {
                    this.layerViewMode = this.layerViewMode === 'layer-first' ? 'color-first' : 'layer-first';
                },
                
                // 生成模拟层号数据（实际项目中应从后端获取）
                generateMockLayerData() {
                    return [
                        { layer: 1, colorCode: 'BU001', formula: '蓝5g 白2g' },
                        { layer: 2, colorCode: 'YE003', formula: '黄8g 红1g' },
                        { layer: 3, colorCode: 'RD005', formula: '红10g 黑1g' }
                    ];
                },
                
                // 生成模拟颜色数据（实际项目中应从后端获取）
                generateMockColorData() {
                    return [
                        { colorCode: 'BU001', formula: '蓝5g 白2g', layers: [1, 5] },
                        { colorCode: 'YE003', formula: '黄8g 红1g', layers: [2] },
                        { colorCode: 'RD005', formula: '红10g 黑1g', layers: [3, 4] }
                    ];
                },
                
                // 处理自配颜色图片上传
                handleColorImageChange(file) {
                    this.colorForm.imageFile = file.raw;
                    // 创建预览
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.colorForm.imagePreview = e.target.result;
                    };
                    reader.readAsDataURL(file.raw);
                },
                
                // 处理蒙马特颜色图片上传
                handleMontMarteImageChange(file) {
                    this.montMarteForm.imageFile = file.raw;
                    // 创建预览
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.montMarteForm.imagePreview = e.target.result;
                    };
                    reader.readAsDataURL(file.raw);
                },
                
                // 初始化颜色表单（对话框打开时）
                initColorForm() {
                    // 如果已选择分类，生成颜色编号
                    if (this.colorForm.category_id) {
                        this.generateColorCode(this.colorForm.category_id);
                    } else if (this.activeCategory && this.activeCategory !== 'all') {
                        // 使用当前选中的分类
                        this.colorForm.category_id = parseInt(this.activeCategory);
                        this.generateColorCode(this.colorForm.category_id);
                    }
                },
                
                // 当分类改变时，重新生成颜色编号
                onCategoryChange(categoryId) {
                    if (categoryId && !this.colorForm.color_code) {
                        // 只有在颜色编号为空时才自动生成
                        this.generateColorCode(categoryId);
                    } else if (categoryId && this.colorForm.color_code) {
                        // 如果已有编号，检查是否需要更新前缀
                        const category = this.categories.find(c => c.id === categoryId);
                        if (category) {
                            const currentPrefix = this.colorForm.color_code.match(/^[A-Z]+/);
                            if (currentPrefix && currentPrefix[0] !== category.code) {
                                // 如果前缀不匹配，生成新编号
                                this.generateColorCode(categoryId);
                            }
                        }
                    }
                },
                
                // 生成颜色编号
                generateColorCode(categoryId) {
                    const category = this.categories.find(c => c.id === categoryId);
                    if (!category) return;
                    
                    // 获取该分类下的所有颜色编号
                    const categoryColors = this.customColors.filter(c => c.category_id === categoryId);
                    
                    if (categoryColors.length === 0) {
                        // 如果该分类下没有颜色，从001开始
                        this.colorForm.color_code = `${category.code}001`;
                        return;
                    }
                    
                    // 提取所有编号中的数字部分
                    const numbers = categoryColors
                        .map(color => {
                            const match = color.color_code.match(/\d+$/);
                            return match ? parseInt(match[0]) : 0;
                        })
                        .filter(num => num > 0);
                    
                    if (numbers.length === 0) {
                        this.colorForm.color_code = `${category.code}001`;
                        return;
                    }
                    
                    // 找到最大的编号
                    const maxNumber = Math.max(...numbers);
                    
                    // 生成下一个编号（最大编号+1，并保持位数）
                    const nextNumber = maxNumber + 1;
                    const paddedNumber = String(nextNumber).padStart(3, '0');
                    
                    this.colorForm.color_code = `${category.code}${paddedNumber}`;
                },
                
                // 验证颜色编号是否重复
                validateColorCode(rule, value, callback) {
                    if (value) {
                        // 检查颜色编号是否已存在
                        const exists = this.customColors.some(color => 
                            color.color_code === value
                        );
                        if (exists) {
                            callback(new Error('该颜色编号已存在！'));
                        } else {
                            // 检查编号格式是否正确（可选）
                            const pattern = /^[A-Z]{2}\d{3}$/;
                            if (!pattern.test(value)) {
                                callback(new Error('颜色编号格式应为：两个大写字母+三位数字，如BU001'));
                            } else {
                                callback();
                            }
                        }
                    } else {
                        callback();
                    }
                },
                
                // 保存自配颜色
                async saveColor() {
                    // 保存滚动位置
                    this.saveScrollPosition();
                    
                    // 验证表单
                    const valid = await this.$refs.colorFormRef.validate().catch(() => false);
                    if (!valid) {
                        return;
                    }
                    
                    // 再次检查是否重复（防止并发问题）
                    const exists = this.customColors.some(color => 
                        color.color_code === this.colorForm.color_code
                    );
                    if (exists) {
                        this.$message.error('该颜色编号已存在！');
                        return;
                    }
                    
                    try {
                        const formData = new FormData();
                        formData.append('category_id', this.colorForm.category_id);
                        formData.append('color_code', this.colorForm.color_code);
                        formData.append('formula', this.colorForm.formula);
                        formData.append('applicable_layers', this.colorForm.applicable_layers);
                        if (this.colorForm.imageFile) {
                            formData.append('image', this.colorForm.imageFile);
                        }
                        
                        await axios.post(`${API_BASE_URL}/custom-colors`, formData, {
                            headers: { 'Content-Type': 'multipart/form-data' }
                        });
                        
                        this.$message.success('自配颜色添加成功');
                        this.showAddColorDialog = false;
                        this.resetColorForm();
                        await this.loadCustomColors();
                        
                        // 恢复滚动位置
                        this.restoreScrollPosition();
                    } catch (error) {
                        console.error('保存自配颜色失败:', error);
                        if (error.response && error.response.data && error.response.data.error) {
                            if (error.response.data.error.includes('UNIQUE constraint')) {
                                this.$message.error('该颜色编号已存在！');
                            } else {
                                this.$message.error(error.response.data.error || '保存自配颜色失败');
                            }
                        } else {
                            this.$message.error('保存自配颜色失败');
                        }
                        // 如果保存失败也恢复滚动位置
                        this.restoreScrollPosition();
                    }
                },
                
                // 保存作品
                async saveArtwork() {
                    try {
                        await axios.post(`${API_BASE_URL}/artworks`, this.artworkForm);
                        this.$message.success('作品添加成功');
                        this.showAddArtworkDialog = false;
                        this.resetArtworkForm();
                        await this.loadArtworks();
                    } catch (error) {
                        console.error('保存作品失败:', error);
                        this.$message.error('保存作品失败');
                    }
                },
                
                // 验证颜色名称是否重复
                validateColorName(rule, value, callback) {
                    if (value) {
                        // 检查颜色名称是否已存在（不区分大小写）
                        // 如果是编辑模式，排除当前编辑的颜色
                        const exists = this.montMarteColors.some(color => 
                            color.name.toLowerCase() === value.toLowerCase() && 
                            color.id !== this.montMarteForm.id
                        );
                        if (exists) {
                            callback(new Error('列表中已经存在该颜色！'));
                        } else {
                            callback();
                        }
                    } else {
                        callback();
                    }
                },
                
                // 保存蒙马特颜色（新增或修改）
                async saveMontMarteColor() {
                    // 验证表单
                    const valid = await this.$refs.montMarteFormRef.validate().catch(() => false);
                    if (!valid) {
                        return;
                    }
                    
                    // 再次检查是否重复（防止并发问题）
                    const exists = this.montMarteColors.some(color => 
                        color.name.toLowerCase() === this.montMarteForm.name.toLowerCase() &&
                        color.id !== this.montMarteForm.id
                    );
                    if (exists) {
                        this.$message.error('列表中已经存在该颜色！');
                        return;
                    }
                    
                    try {
                        const formData = new FormData();
                        formData.append('name', this.montMarteForm.name);
                        
                        if (this.montMarteForm.imageFile) {
                            formData.append('image', this.montMarteForm.imageFile);
                        } else if (this.montMarteForm.existingImagePath) {
                            // 如果没有新图片但有旧图片，传递旧图片路径
                            formData.append('existingImagePath', this.montMarteForm.existingImagePath);
                        }
                        
                        let response;
                        if (this.montMarteForm.id) {
                            // 修改模式
                            response = await axios.put(
                                `${API_BASE_URL}/mont-marte-colors/${this.montMarteForm.id}`, 
                                formData,
                                { headers: { 'Content-Type': 'multipart/form-data' } }
                            );
                            this.$message.success('颜色原料修改成功');
                        } else {
                            // 新增模式
                            response = await axios.post(
                                `${API_BASE_URL}/mont-marte-colors`, 
                                formData,
                                { headers: { 'Content-Type': 'multipart/form-data' } }
                            );
                            this.$message.success('颜色原料添加成功');
                        }
                        
                        this.showAddMontMarteDialog = false;
                        this.resetMontMarteForm();
                        await this.loadMontMarteColors(true); // 保持滚动位置并重新排序
                    } catch (error) {
                        console.error('保存颜色原料失败:', error);
                        // 检查是否是后端返回的重复错误
                        if (error.response && error.response.data && error.response.data.error) {
                            if (error.response.data.error.includes('UNIQUE constraint') || 
                                error.response.data.error.includes('已存在')) {
                                this.$message.error('列表中已经存在该颜色！');
                            } else {
                                this.$message.error('保存颜色原料失败');
                            }
                        } else {
                            this.$message.error('保存颜色原料失败');
                        }
                    }
                },
                
                // 删除蒙马特颜色
                async deleteMontMarteColor(color) {
                    try {
                        await this.$confirm(
                            `确定要删除颜色 "${color.name}" 吗？`,
                            '删除确认',
                            {
                                confirmButtonText: '确认',
                                cancelButtonText: '取消',
                                type: 'warning'
                            }
                        );
                        
                        // 用户点击确认，执行删除
                        const response = await axios.delete(`${API_BASE_URL}/mont-marte-colors/${color.id}`);
                        
                        if (response.data.success) {
                            this.$message.success('颜色删除成功');
                            await this.loadMontMarteColors(true); // 保持滚动位置并重新排序
                        }
                    } catch (error) {
                        if (error === 'cancel') {
                            // 用户点击取消，不做任何操作
                            return;
                        }
                        
                        // 处理删除错误
                        if (error.response && error.response.data && error.response.data.error) {
                            if (error.response.data.error.includes('被引用')) {
                                this.$message.error('此颜色已被自配色引用，暂时无法删除');
                            } else {
                                this.$message.error(error.response.data.error || '删除失败');
                            }
                        } else {
                            console.error('删除颜色失败:', error);
                            this.$message.error('删除失败');
                        }
                    }
                },
                
                // 保存滚动位置
                saveScrollPosition() {
                    this.scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
                },
                
                // 恢复滚动位置
                restoreScrollPosition() {
                    this.$nextTick(() => {
                        window.scrollTo(0, this.scrollPosition);
                    });
                },
                
                // 点击按名称排序
                sortByNameClick() {
                    this.saveScrollPosition();
                    this.montMarteSortType = 'name';
                    this.sortByName();
                    this.restoreScrollPosition();
                    this.$message.success('已按名称排序');
                },
                
                // 点击按时间排序
                sortByTimeClick() {
                    this.saveScrollPosition();
                    this.montMarteSortType = 'time';
                    this.sortByTime();
                    this.restoreScrollPosition();
                    this.$message.success('已按修改时间排序');
                },
                
                // 排序蒙马特颜色
                sortMontMarteColors() {
                    if (this.montMarteSortType === 'name') {
                        this.sortByName();
                    } else if (this.montMarteSortType === 'time') {
                        this.sortByTime();
                    }
                },
                
                // 按名称排序
                sortByName() {
                    this.montMarteColors.sort((a, b) => {
                        return this.compareNames(a.name, b.name);
                    });
                },
                
                // 按修改时间排序（最新的在前）
                sortByTime() {
                    this.montMarteColors.sort((a, b) => {
                        const timeA = new Date(a.updated_at || a.created_at).getTime();
                        const timeB = new Date(b.updated_at || b.created_at).getTime();
                        return timeB - timeA; // 降序，最新的在前
                    });
                },
                
                // 比较两个名称（实现特殊的排序规则）
                compareNames(nameA, nameB) {
                    // 获取字符类型：1=特殊字符, 2=数字, 3=英文, 4=中文
                    const getCharType = (str) => {
                        if (!str || str.length === 0) return 1;
                        const firstChar = str[0];
                        const code = firstChar.charCodeAt(0);
                        
                        // 特殊字符和标点符号
                        if (code < 48 || (code > 57 && code < 65) || (code > 90 && code < 97) || (code > 122 && code < 0x4e00)) {
                            return 1;
                        }
                        // 数字
                        if (code >= 48 && code <= 57) {
                            return 2;
                        }
                        // 英文字母
                        if ((code >= 65 && code <= 90) || (code >= 97 && code <= 122)) {
                            return 3;
                        }
                        // 中文
                        if (code >= 0x4e00 && code <= 0x9fff) {
                            return 4;
                        }
                        return 1; // 其他情况归为特殊字符
                    };
                    
                    const typeA = getCharType(nameA);
                    const typeB = getCharType(nameB);
                    
                    // 不同类型按优先级排序
                    if (typeA !== typeB) {
                        return typeA - typeB;
                    }
                    
                    // 相同类型的处理
                    if (typeA === 4) {
                        // 中文使用 localeCompare 的中文排序
                        return nameA.localeCompare(nameB, 'zh-CN', { numeric: true });
                    } else if (typeA === 2) {
                        // 数字按数值大小排序
                        const numA = parseInt(nameA.match(/^\d+/)[0]);
                        const numB = parseInt(nameB.match(/^\d+/)[0]);
                        if (numA !== numB) {
                            return numA - numB;
                        }
                        // 如果数字相同，比较后续部分
                        return nameA.localeCompare(nameB);
                    } else {
                        // 特殊字符和英文使用默认比较
                        return nameA.localeCompare(nameB);
                    }
                },
                
                // 重置表单
                resetColorForm() {
                    this.colorForm = {
                        category_id: '',
                        color_code: '',
                        formula: '',
                        applicable_layers: '',
                        imageFile: null,
                        imagePreview: null
                    };
                    // 重置表单验证状态
                    if (this.$refs.colorFormRef) {
                        this.$refs.colorFormRef.resetFields();
                    }
                },
                
                resetArtworkForm() {
                    this.artworkForm = {
                        code: '',
                        name: ''
                    };
                },
                
                resetMontMarteForm() {
                    this.montMarteForm = {
                        id: null,
                        name: '',
                        imageFile: null,
                        imagePreview: null,
                        existingImagePath: null
                    };
                    // 重置表单验证状态
                    if (this.$refs.montMarteFormRef) {
                        this.$refs.montMarteFormRef.resetFields();
                    }
                },
                
                // 格式化日期
                formatDate(dateString) {
                    if (!dateString) return '未知';
                    return new Date(dateString).toLocaleString('zh-CN');
                },
                
                // 待实现的方法（占位符）
                addCategory() {
                    this.$message.info('添加分类功能待实现');
                },
                
                editColor(color) {
                    this.$message.info('修改颜色功能待实现');
                },
                
                viewColorHistory(color) {
                    this.$message.info('颜色历史回溯功能待实现');
                },
                
                addScheme(artwork) {
                    this.$message.info('添加配色方案功能待实现');
                },
                
                editScheme(scheme) {
                    this.$message.info('修改配色方案功能待实现');
                },
                
                viewSchemeHistory(scheme) {
                    this.$message.info('配色方案历史回溯功能待实现');
                },
                
                editMontMarteColor(color) {
                    // 设置表单为编辑模式
                    this.montMarteForm = {
                        id: color.id,
                        name: color.name,
                        imageFile: null,
                        imagePreview: color.image_path ? `${this.baseURL}/${color.image_path}` : null,
                        existingImagePath: color.image_path
                    };
                    this.showAddMontMarteDialog = true;
                }
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>